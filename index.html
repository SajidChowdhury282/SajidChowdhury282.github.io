<!DOCTYPE html>
<html>
<head>
    <title>Rugby Budget Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background-color: #1a4784;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .widget {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
        }
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .widget-title {
            margin: 0;
            color: #1a4784;
        }
        .widget-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .row {
            display: flex;
            gap: 20px;
        }
        .col {
            flex: 1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        .category {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .variable {
            background-color: #ffecb3;
            color: #ff8f00;
        }
        .constant {
            background-color: #c8e6c9;
            color: #2e7d32;
        }
        .chart-container {
            height: 300px;
            position: relative;
        }
        select, input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        select[multiple] {
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .flex-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .summary-item {
            background-color: #f2f2f2;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .summary-label {
            font-size: 14px;
            color: #666;
        }
        .positive {
            color: #2e7d32;
        }
        .negative {
            color: #c62828;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #1a4784;
            color: white;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #0d2b50;
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .action-cell {
            display: flex;
            gap: 5px;
        }
        .action-btn {
            cursor: pointer;
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 3px;
            border: none;
        }
        .edit-btn {
            background-color: #1a4784;
            color: white;
        }
        .delete-btn {
            background-color: #c62828;
            color: white;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>Men's Rugby Budget Dashboard</h1>
        </div>
        
        <div class="widget">
            <div class="widget-header">
                <h2 class="widget-title">Budget Summary</h2>
                <div class="controls">
                    <select id="fiscalYearSelect">
                        <option value="FY25">FY25</option>
                        <option value="FY26">FY26 (Projected)</option>
                    </select>
                    <button class="btn" id="addYearBtn">Add New Year</button>
                </div>
            </div>
            <div class="widget-body">
                <div class="row">
                    <div class="col summary-item">
                        <div class="summary-label">Total Income</div>
                        <div class="summary-value positive" id="totalIncome">$54,253.21</div>
                    </div>
                    <div class="col summary-item">
                        <div class="summary-label">Total Expenses</div>
                        <div class="summary-value negative" id="totalExpenses">$35,010.42</div>
                    </div>
                    <div class="col summary-item">
                        <div class="summary-label">Net Balance</div>
                        <div class="summary-value positive" id="netBalance">$19,242.79</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="summaryChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col">
                <div class="widget">
                    <div class="widget-header">
                        <h2 class="widget-title">Income Sources</h2>
                        <div class="controls">
                            <select id="incomeChartType">
                                <option value="pie">Pie Chart</option>
                                <option value="bar">Bar Chart</option>
                            </select>
                        </div>
                    </div>
                    <div class="widget-body">
                        <div class="chart-container">
                            <canvas id="incomeChart"></canvas>
                        </div>
                        <table id="incomeTable">
                            <thead>
                                <tr>
                                    <th>Income Source</th>
                                    <th>Amount</th>
                                    <th>Category</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Income data will be inserted here via JavaScript -->
                            </tbody>
                        </table>
                        <div class="flex-container">
                            <button class="btn" id="addIncomeBtn">Add Income</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col">
                <div class="widget">
                    <div class="widget-header">
                        <h2 class="widget-title">Expenses Breakdown</h2>
                        <div class="controls">
                            <select id="expenseChartType">
                                <option value="pie">Pie Chart</option>
                                <option value="bar">Bar Chart</option>
                            </select>
                            <select id="expenseCategory">
                                <option value="all">All Categories</option>
                                <option value="variable">Variable Costs</option>
                                <option value="constant">Constant Costs</option>
                            </select>
                        </div>
                    </div>
                    <div class="widget-body">
                        <div class="chart-container">
                            <canvas id="expenseChart"></canvas>
                        </div>
                        <table id="expenseTable">
                            <thead>
                                <tr>
                                    <th>Expense Item</th>
                                    <th>Amount</th>
                                    <th>Cost Type</th>
                                    <th>Category</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Expense data will be inserted here via JavaScript -->
                            </tbody>
                        </table>
                        <div class="flex-container">
                            <button class="btn" id="addExpenseBtn">Add Expense</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget">
            <div class="widget-header">
                <h2 class="widget-title">Year-over-Year Budget Comparison</h2>
                <div class="controls">
                    <label for="comparisonYears">Compare Years:</label>
                    <select id="comparisonYears" multiple size="4" style="min-width: 180px; max-height: 120px;">
                        <!-- Year options will be generated here -->
                    </select>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button class="btn" id="selectAllYearsBtn" style="font-size: 12px; padding: 4px 8px;">Select All</button>
                        <button class="btn" id="clearYearsBtn" style="font-size: 12px; padding: 4px 8px;">Clear All</button>
                        <div style="font-size: 11px; color: #666; text-align: center; margin-top: 5px;">
                            Hold Ctrl/Cmd<br>to select multiple
                        </div>
                    </div>
                </div>
            </div>
            <div class="widget-body">
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding/editing expenses -->
    <div id="expenseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; width: 400px; padding: 20px; margin: 100px auto; border-radius: 8px;">
            <h3 id="expenseModalTitle">Add/Edit Expense</h3>
            <div style="margin-bottom: 10px;">
                <label>Description:</label>
                <input type="text" id="expenseDescription" style="width: 100%;">
            </div>
            <div style="margin-bottom: 10px;">
                <label>Amount ($):</label>
                <input type="number" id="expenseAmount" style="width: 100%;">
            </div>
            <div style="margin-bottom: 10px;">
                <label>Cost Type:</label>
                <select id="expenseCostType" style="width: 100%;">
                    <option value="variable">Variable Cost</option>
                    <option value="constant">Constant Cost</option>
                </select>
            </div>
            <div style="margin-bottom: 10px;">
                <label>Category:</label>
                <select id="expenseCategorySelect" style="width: 100%;">
                    <option value="Transportation">Transportation</option>
                    <option value="Equipment">Equipment</option>
                    <option value="Membership">Membership</option>
                    <option value="Officials">Officials</option>
                    <option value="Uniforms">Uniforms</option>
                    <option value="Travel">Travel</option>
                    <option value="Events">Events</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <button id="cancelExpenseBtn" class="btn" style="background-color: #ccc;">Cancel</button>
                <button id="saveExpenseBtn" class="btn">Save</button>
            </div>
            <input type="hidden" id="editExpenseIndex" value="-1">
        </div>
    </div>

    <!-- Modal for adding/editing income -->
    <div id="incomeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; width: 400px; padding: 20px; margin: 100px auto; border-radius: 8px;">
            <h3 id="incomeModalTitle">Add/Edit Income</h3>
            <div style="margin-bottom: 10px;">
                <label>Description:</label>
                <input type="text" id="incomeDescription" style="width: 100%;">
            </div>
            <div style="margin-bottom: 10px;">
                <label>Amount ($):</label>
                <input type="number" id="incomeAmount" style="width: 100%;">
            </div>
            <div style="margin-bottom: 10px;">
                <label>Category:</label>
                <select id="incomeCategorySelect" style="width: 100%;">
                    <option value="Allocation">Co-Curricular Allocation</option>
                    <option value="Dues">Dues</option>
                    <option value="Gifts">Gifts</option>
                    <option value="Fundraising">Fundraising</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <button id="cancelIncomeBtn" class="btn" style="background-color: #ccc;">Cancel</button>
                <button id="saveIncomeBtn" class="btn">Save</button>
            </div>
            <input type="hidden" id="editIncomeIndex" value="-1">
        </div>
    </div>

    <!-- Modal for adding new fiscal year -->
    <div id="yearModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; width: 400px; padding: 20px; margin: 100px auto; border-radius: 8px;">
            <h3>Add New Fiscal Year</h3>
            <div style="margin-bottom: 10px;">
                <label>Fiscal Year Name (e.g., FY27):</label>
                <input type="text" id="newYearName" style="width: 100%;">
            </div>
            <div style="margin-bottom: 10px;">
                <label>Base data on existing year:</label>
                <select id="baseYearSelect" style="width: 100%;">
                    <option value="none">None (Start Empty)</option>
                    <!-- Existing years will be populated here -->
                </select>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <button id="cancelYearBtn" class="btn" style="background-color: #ccc;">Cancel</button>
                <button id="saveYearBtn" class="btn">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Define color palette
        const colors = [
            '#1a4784', // Primary blue
            '#2e7d32', // Green
            '#ff8f00', // Orange
            '#c62828', // Red
            '#6a1b9a', // Purple
            '#00838f', // Teal
            '#558b2f', // Light green
            '#ef6c00', // Dark orange
            '#5d4037', // Brown
            '#546e7a'  // Blue grey
        ];

        // Initialize data
        let incomeData = {
            FY25: [
                { description: 'Co-Curricular Allocation', amount: 15000, category: 'Allocation' },
                { description: 'Fundraising Account (Dues)', amount: 16248, category: 'Dues' },
                { description: 'Gift Account', amount: 23005.21, category: 'Gifts' }
            ],
            FY26: [
                { description: 'Carry Forward from FY25', amount: 19242.79, category: 'Other' },
                { description: 'Co-Curricular Allocation', amount: 15000, category: 'Allocation' },
                { description: 'Anticipated Gift (Agreement)', amount: 5000, category: 'Gifts' }
            ]
        };

        let expenseData = {
            FY25: [
                { description: 'Veo Camera Subscription', amount: 1790, costType: 'constant', category: 'Equipment' },
                { description: 'Hale Bus', amount: 10400, costType: 'variable', category: 'Transportation' },
                { description: 'National Collegiate Rugby', amount: 4817, costType: 'constant', category: 'Membership' },
                { description: 'Liberty Rugby Conference', amount: 1500, costType: 'constant', category: 'Membership' },
                { description: 'Videographer', amount: 1500, costType: 'variable', category: 'Other' },
                { description: 'NYS Rugby Referees', amount: 800, costType: 'variable', category: 'Officials' },
                { description: 'Individual Referees', amount: 390, costType: 'variable', category: 'Officials' },
                { description: 'Recruitment Registration', amount: 100, costType: 'constant', category: 'Other' },
                { description: 'Akuma Uniform/Kits', amount: 10227.90, costType: 'variable', category: 'Uniforms' },
                { description: 'International Service Charge', amount: 228.12, costType: 'constant', category: 'Other' },
                { description: 'Akuma Freight', amount: 129.62, costType: 'variable', category: 'Uniforms' },
                { description: 'Akuma Added Uniforms', amount: 328, costType: 'variable', category: 'Uniforms' },
                { description: 'Fairfield Hotel', amount: 695.92, costType: 'variable', category: 'Travel' },
                { description: 'Ottawa Hotel', amount: 718.98, costType: 'variable', category: 'Travel' },
                { description: 'Additional Videographer', amount: 225, costType: 'variable', category: 'Other' },
                { description: 'Fundraising Dinner Event (Net Cost)', amount: 1388, costType: 'variable', category: 'Events' }
            ],
            FY26: []
        };

        // Chart instances
        let summaryChart;
        let incomeChart;
        let expenseChart;
        let comparisonChart;

        // Selected fiscal year
        let selectedYear = 'FY25';
        
        // Comparison years for year-over-year chart
        let selectedComparisonYears = ['FY25', 'FY26'];

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Update tables
            updateIncomeTables();
            updateExpenseTables();
            
            // Initialize charts
            initializeCharts();
            updateAllCharts();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize year selector
            updateYearSelector();
            
            // Add export/import buttons
            addExportImportButtons();
        });

        function updateIncomeTables() {
            const tableBody = document.getElementById('incomeTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            incomeData[selectedYear].forEach((item, index) => {
                const row = tableBody.insertRow();
                
                const cellDesc = row.insertCell(0);
                cellDesc.textContent = item.description;
                
                const cellAmount = row.insertCell(1);
                cellAmount.textContent = `$${item.amount.toFixed(2)}`;
                
                const cellCategory = row.insertCell(2);
                cellCategory.textContent = item.category;
                
                // Add action buttons (edit/delete)
                const cellActions = row.insertCell(3);
                cellActions.className = 'action-cell';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'action-btn edit-btn';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => {
                    editIncomeItem(index);
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => {
                    deleteIncomeItem(index);
                });
                
                cellActions.appendChild(editBtn);
                cellActions.appendChild(deleteBtn);
            });
        }

        function updateExpenseTables() {
            const tableBody = document.getElementById('expenseTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            const categoryFilter = document.getElementById('expenseCategory').value;
            
            const filteredExpenses = expenseData[selectedYear].filter(expense => {
                if (categoryFilter === 'all') return true;
                return expense.costType === categoryFilter;
            });
            
            filteredExpenses.forEach((item, index) => {
                const originalIndex = expenseData[selectedYear].indexOf(item);
                const row = tableBody.insertRow();
                
                const cellDesc = row.insertCell(0);
                cellDesc.textContent = item.description;
                
                const cellAmount = row.insertCell(1);
                cellAmount.textContent = `$${item.amount.toFixed(2)}`;
                
                const cellCostType = row.insertCell(2);
                const costTypeSpan = document.createElement('span');
                costTypeSpan.className = `category ${item.costType}`;
                costTypeSpan.textContent = item.costType.charAt(0).toUpperCase() + item.costType.slice(1);
                cellCostType.appendChild(costTypeSpan);
                
                const cellCategory = row.insertCell(3);
                cellCategory.textContent = item.category;
                
                // Add action buttons (edit/delete)
                const cellActions = row.insertCell(4);
                cellActions.className = 'action-cell';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'action-btn edit-btn';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => {
                    editExpenseItem(originalIndex);
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => {
                    deleteExpenseItem(originalIndex);
                });
                
                cellActions.appendChild(editBtn);
                cellActions.appendChild(deleteBtn);
            });
        }

        function initializeCharts() {
            // Summary Chart
            const summaryCtx = document.getElementById('summaryChart').getContext('2d');
            summaryChart = new Chart(summaryCtx, {
                type: 'bar',
                data: {
                    labels: ['Income', 'Expenses', 'Balance'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [colors[1], colors[3], colors[0]],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Income Chart
            const incomeCtx = document.getElementById('incomeChart').getContext('2d');
            incomeChart = new Chart(incomeCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `$${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Expense Chart
            const expenseCtx = document.getElementById('expenseChart').getContext('2d');
            expenseChart = new Chart(expenseCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `$${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Comparison Chart
            const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(comparisonCtx, {
                type: 'bar',
                data: {
                    labels: ['Income', 'Expenses', 'Balance'],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.raw.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateSummaryChart() {
            const totalIncome = incomeData[selectedYear].reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = expenseData[selectedYear].reduce((sum, item) => sum + item.amount, 0);
            const balance = totalIncome - totalExpenses;
            
            document.getElementById('totalIncome').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('netBalance').textContent = `$${balance.toFixed(2)}`;
            
            summaryChart.data.datasets[0].data = [totalIncome, totalExpenses, balance];
            summaryChart.update();
        }

        function updateIncomeChart() {
            const chartType = document.getElementById('incomeChartType').value;
            incomeChart.config.type = chartType;
            
            // Group income by category
            const categorizedIncome = {};
            incomeData[selectedYear].forEach(item => {
                if (!categorizedIncome[item.category]) {
                    categorizedIncome[item.category] = 0;
                }
                categorizedIncome[item.category] += item.amount;
            });
            
            const labels = Object.keys(categorizedIncome);
            const data = labels.map(label => categorizedIncome[label]);
            
            incomeChart.data.labels = labels;
            incomeChart.data.datasets[0].data = data;
            
            incomeChart.update();
        }

        function updateExpenseChart() {
            const chartType = document.getElementById('expenseChartType').value;
            const categoryFilter = document.getElementById('expenseCategory').value;
            
            expenseChart.config.type = chartType;
            
            // Filter expenses if needed
            const filteredExpenses = expenseData[selectedYear].filter(expense => {
                if (categoryFilter === 'all') return true;
                return expense.costType === categoryFilter;
            });
            
            // Group expenses by category
            const categorizedExpenses = {};
            filteredExpenses.forEach(item => {
                if (!categorizedExpenses[item.category]) {
                    categorizedExpenses[item.category] = 0;
                }
                categorizedExpenses[item.category] += item.amount;
            });
            
            const labels = Object.keys(categorizedExpenses);
            const data = labels.map(label => categorizedExpenses[label]);
            
            expenseChart.data.labels = labels;
            expenseChart.data.datasets[0].data = data;
            
            expenseChart.update();
        }

        function updateComparisonChart() {
            // Clear existing datasets
            comparisonChart.data.datasets = [];
            
            console.log('Updating comparison chart with years:', selectedComparisonYears); // Debug log
            
            // Only show data for selected years
            selectedComparisonYears.forEach((year, index) => {
                if (incomeData[year] && expenseData[year]) {
                    const income = incomeData[year].reduce((sum, item) => sum + item.amount, 0);
                    const expenses = expenseData[year].reduce((sum, item) => sum + item.amount, 0);
                    const balance = income - expenses;
                    
                    comparisonChart.data.datasets.push({
                        label: year,
                        data: [income, expenses, balance],
                        backgroundColor: colors[index % colors.length],
                        borderWidth: 0
                    });
                }
            });
            
            // If no years selected, show a message or empty chart
            if (selectedComparisonYears.length === 0) {
                comparisonChart.data.datasets = [];
            }
            
            comparisonChart.update();
        }

        function updateAllCharts() {
            updateSummaryChart();
            updateIncomeChart();
            updateExpenseChart();
            updateComparisonChart();
        }

        function updateYearSelector() {
            const comparisonSelect = document.getElementById('comparisonYears');
            const previousSelections = Array.from(comparisonSelect.selectedOptions).map(option => option.value);
            comparisonSelect.innerHTML = '';
            
            const years = Object.keys(incomeData).sort(); // Sort years for better organization
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                // Preserve previous selections or use default
                option.selected = previousSelections.length > 0 ? 
                    previousSelections.includes(year) : 
                    selectedComparisonYears.includes(year);
                comparisonSelect.appendChild(option);
            });
            
            // Update selectedComparisonYears based on current selections
            selectedComparisonYears = Array.from(comparisonSelect.selectedOptions).map(option => option.value);
            
            // Remove existing event listeners to avoid duplicates
            const newSelect = comparisonSelect.cloneNode(true);
            comparisonSelect.parentNode.replaceChild(newSelect, comparisonSelect);
            
            // Add event listener for the multi-select
            document.getElementById('comparisonYears').addEventListener('change', function() {
                selectedComparisonYears = Array.from(this.selectedOptions).map(option => option.value);
                console.log('Selected years for comparison:', selectedComparisonYears); // Debug log
                updateComparisonChart();
            });
            
            // Update the chart with current selections
            updateComparisonChart();
        }

        function setupEventListeners() {
            // Fiscal Year change
            document.getElementById('fiscalYearSelect').addEventListener('change', function() {
                selectedYear = this.value;
                updateIncomeTables();
                updateExpenseTables();
                updateAllCharts();
            });
            
            // Income chart type change
            document.getElementById('incomeChartType').addEventListener('change', function() {
                updateIncomeChart();
            });
            
            // Expense chart type and category change
            document.getElementById('expenseChartType').addEventListener('change', function() {
                updateExpenseChart();
            });
            
            document.getElementById('expenseCategory').addEventListener('change', function() {
                updateExpenseTables();
                updateExpenseChart();
            });
            
            // Year comparison controls
            document.getElementById('selectAllYearsBtn').addEventListener('click', function() {
                const comparisonSelect = document.getElementById('comparisonYears');
                const options = comparisonSelect.options;
                selectedComparisonYears = [];
                
                // Select all options
                for (let i = 0; i < options.length; i++) {
                    options[i].selected = true;
                    selectedComparisonYears.push(options[i].value);
                }
                console.log('Select All - Selected years:', selectedComparisonYears); // Debug log
                updateComparisonChart();
            });
            
            document.getElementById('clearYearsBtn').addEventListener('click', function() {
                const comparisonSelect = document.getElementById('comparisonYears');
                const options = comparisonSelect.options;
                selectedComparisonYears = [];
                
                // Deselect all options
                for (let i = 0; i < options.length; i++) {
                    options[i].selected = false;
                }
                console.log('Clear All - Selected years:', selectedComparisonYears); // Debug log
                updateComparisonChart();
            });
            
            // Add income button
            document.getElementById('addIncomeBtn').addEventListener('click', function() {
                document.getElementById('incomeModalTitle').textContent = 'Add Income';
                document.getElementById('incomeDescription').value = '';
                document.getElementById('incomeAmount').value = '';
                document.getElementById('incomeCategorySelect').value = 'Allocation';
                document.getElementById('editIncomeIndex').value = '-1';
                document.getElementById('incomeModal').style.display = 'block';
            });
            
            // Cancel income button
            document.getElementById('cancelIncomeBtn').addEventListener('click', function() {
                document.getElementById('incomeModal').style.display = 'none';
            });
            
            // Save income button
            document.getElementById('saveIncomeBtn').addEventListener('click', function() {
                const description = document.getElementById('incomeDescription').value;
                const amount = parseFloat(document.getElementById('incomeAmount').value);
                const category = document.getElementById('incomeCategorySelect').value;
                const editIndex = parseInt(document.getElementById('editIncomeIndex').value);
                
                if (!description || isNaN(amount) || amount <= 0) {
                    alert('Please fill in all fields with valid values.');
                    return;
                }
                
                if (editIndex >= 0) {
                    // Edit existing item
                    incomeData[selectedYear][editIndex] = { description, amount, category };
                } else {
                    // Add new item
                    incomeData[selectedYear].push({ description, amount, category });
                }
                
                document.getElementById('incomeModal').style.display = 'none';
                updateIncomeTables();
                updateAllCharts();
            });
            
            // Add expense button
            document.getElementById('addExpenseBtn').addEventListener('click', function() {
                document.getElementById('expenseModalTitle').textContent = 'Add Expense';
                document.getElementById('expenseDescription').value = '';
                document.getElementById('expenseAmount').value = '';
                document.getElementById('expenseCostType').value = 'variable';
                document.getElementById('expenseCategorySelect').value = 'Transportation';
                document.getElementById('editExpenseIndex').value = '-1';
                document.getElementById('expenseModal').style.display = 'block';
            });
            
            // Cancel expense button
            document.getElementById('cancelExpenseBtn').addEventListener('click', function() {
                document.getElementById('expenseModal').style.display = 'none';
            });
            
            // Save expense button
            document.getElementById('saveExpenseBtn').addEventListener('click', function() {
                const description = document.getElementById('expenseDescription').value;
                const amount = parseFloat(document.getElementById('expenseAmount').value);
                const costType = document.getElementById('expenseCostType').value;
                const category = document.getElementById('expenseCategorySelect').value;
                const editIndex = parseInt(document.getElementById('editExpenseIndex').value);
                
                if (!description || isNaN(amount) || amount <= 0) {
                    alert('Please fill in all fields with valid values.');
                    return;
                }
                
                if (editIndex >= 0) {
                    // Edit existing item
                    expenseData[selectedYear][editIndex] = { description, amount, costType, category };
                } else {
                    // Add new item
                    expenseData[selectedYear].push({ description, amount, costType, category });
                }
                
                document.getElementById('expenseModal').style.display = 'none';
                updateExpenseTables();
                updateAllCharts();
            });
            
            // Add Year button
            document.getElementById('addYearBtn').addEventListener('click', function() {
                document.getElementById('newYearName').value = '';
                
                // Populate base year dropdown
                const baseYearSelect = document.getElementById('baseYearSelect');
                baseYearSelect.innerHTML = '<option value="none">None (Start Empty)</option>';
                
                for (const year in incomeData) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    baseYearSelect.appendChild(option);
                }
                
                document.getElementById('yearModal').style.display = 'block';
            });
            
            // Cancel Year button
            document.getElementById('cancelYearBtn').addEventListener('click', function() {
                document.getElementById('yearModal').style.display = 'none';
            });
            
            // Save Year button
            document.getElementById('saveYearBtn').addEventListener('click', function() {
                const newYearName = document.getElementById('newYearName').value.trim();
                const baseYear = document.getElementById('baseYearSelect').value;
                
                if (!newYearName || !/^FY\d{2}$/.test(newYearName)) {
                    alert('Please enter a valid fiscal year name (e.g., FY27)');
                    return;
                }
                
                if (incomeData[newYearName]) {
                    alert('This fiscal year already exists.');
                    return;
                }
                
                // Initialize new year data
                if (baseYear === 'none') {
                    incomeData[newYearName] = [];
                    expenseData[newYearName] = [];
                } else {
                    // Copy data from base year
                    incomeData[newYearName] = JSON.parse(JSON.stringify(incomeData[baseYear]));
                    expenseData[newYearName] = JSON.parse(JSON.stringify(expenseData[baseYear]));
                    
                    // Add carry forward if base year has data
                    if (baseYear !== 'none') {
                        const baseIncome = incomeData[baseYear].reduce((sum, item) => sum + item.amount, 0);
                        const baseExpenses = expenseData[baseYear].reduce((sum, item) => sum + item.amount, 0);
                        const carryForward = baseIncome - baseExpenses;
                        
                        if (carryForward > 0) {
                            incomeData[newYearName].unshift({
                                description: `Carry Forward from ${baseYear}`,
                                amount: carryForward,
                                category: 'Other'
                            });
                        }
                    }
                }
                
                // Add new year to fiscal year dropdown
                const yearSelect = document.getElementById('fiscalYearSelect');
                const option = document.createElement('option');
                option.value = newYearName;
                option.textContent = `${newYearName}`;
                yearSelect.appendChild(option);
                
                // Update comparison years
                selectedComparisonYears.push(newYearName);
                
                document.getElementById('yearModal').style.display = 'none';
                updateYearSelector();
                updateAllCharts();
            });
        }

        function editIncomeItem(index) {
            const item = incomeData[selectedYear][index];
            
            document.getElementById('incomeModalTitle').textContent = 'Edit Income';
            document.getElementById('incomeDescription').value = item.description;
            document.getElementById('incomeAmount').value = item.amount;
            document.getElementById('incomeCategorySelect').value = item.category;
            document.getElementById('editIncomeIndex').value = index;
            
            document.getElementById('incomeModal').style.display = 'block';
        }

        function deleteIncomeItem(index) {
            if (confirm('Are you sure you want to delete this income item?')) {
                incomeData[selectedYear].splice(index, 1);
                updateIncomeTables();
                updateAllCharts();
            }
        }

        function editExpenseItem(index) {
            const item = expenseData[selectedYear][index];
            
            document.getElementById('expenseModalTitle').textContent = 'Edit Expense';
            document.getElementById('expenseDescription').value = item.description;
            document.getElementById('expenseAmount').value = item.amount;
            document.getElementById('expenseCostType').value = item.costType;
            document.getElementById('expenseCategorySelect').value = item.category;
            document.getElementById('editExpenseIndex').value = index;
            
            document.getElementById('expenseModal').style.display = 'block';
        }

        function deleteExpenseItem(index) {
            if (confirm('Are you sure you want to delete this expense item?')) {
                expenseData[selectedYear].splice(index, 1);
                updateExpenseTables();
                updateAllCharts();
            }
        }

        // Export to CSV functionality
        function exportToCSV() {
            // Create CSV content for income
            let incomeCSV = 'Fiscal Year,Description,Amount,Category\n';
            for (const year in incomeData) {
                incomeData[year].forEach(item => {
                    incomeCSV += `${year},"${item.description}",${item.amount},"${item.category}"\n`;
                });
            }
            
            // Create CSV content for expenses
            let expenseCSV = 'Fiscal Year,Description,Amount,Cost Type,Category\n';
            for (const year in expenseData) {
                expenseData[year].forEach(item => {
                    expenseCSV += `${year},"${item.description}",${item.amount},"${item.costType}","${item.category}"\n`;
                });
            }
            
            // Create download links
            const incomeBlob = new Blob([incomeCSV], { type: 'text/csv' });
            const incomeURL = URL.createObjectURL(incomeBlob);
            const incomeLink = document.createElement('a');
            incomeLink.href = incomeURL;
            incomeLink.download = 'rugby_income_data.csv';
            
            const expenseBlob = new Blob([expenseCSV], { type: 'text/csv' });
            const expenseURL = URL.createObjectURL(expenseBlob);
            const expenseLink = document.createElement('a');
            expenseLink.href = expenseURL;
            expenseLink.download = 'rugby_expense_data.csv';
            
            // Trigger downloads
            incomeLink.click();
            setTimeout(() => {
                expenseLink.click();
            }, 100);
            
            // Clean up
            setTimeout(() => {
                URL.revokeObjectURL(incomeURL);
                URL.revokeObjectURL(expenseURL);
            }, 500);
        }

        // Add Export/Import buttons to UI
        function addExportImportButtons() {
            const dashboardHeader = document.querySelector('.header');
            
            const buttonsDiv = document.createElement('div');
            buttonsDiv.style.marginTop = '10px';
            buttonsDiv.style.display = 'flex';
            buttonsDiv.style.justifyContent = 'center';
            buttonsDiv.style.gap = '10px';
            
            // Export button
            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn';
            exportBtn.textContent = 'Export Data to CSV';
            exportBtn.addEventListener('click', exportToCSV);
            
            buttonsDiv.appendChild(exportBtn);
            dashboardHeader.appendChild(buttonsDiv);
        }
    </script>
</body>
</html>
